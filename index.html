<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackEnvios Enterprise | Multi-User</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a; --accent: #2563eb; --success: #10b981;
            --danger: #ef4444; --slate: #64748b; --bg: #f1f5f9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--primary); display: flex; height: 100vh; overflow: hidden; }

        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-box { background: white; padding: 40px; border-radius: 24px; width: 380px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 14px; margin: 10px 0; border: 1.5px solid #e2e8f0; border-radius: 12px; font-size: 16px; outline: none; }
        .login-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }

        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--primary); color: white; padding: 30px 20px; display: flex; flex-direction: column; }
        .nav-link { 
            display: flex; align-items: center; padding: 14px 18px; color: #94a3b8; text-decoration: none; 
            border-radius: 12px; margin-bottom: 8px; cursor: pointer; font-weight: 500; transition: 0.3s; border: none; background: none; width: 100%; font-size: 15px;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: var(--accent); color: white; }
        .admin-only { border-left: 3px solid var(--warning); padding-left: 10px; margin-top: 10px; display: none; } /* Oculto para operadores */

        /* CONTENT */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 30px; }
        
        /* TABLES */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: var(--slate); font-size: 12px; font-weight: 700; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-content { background: white; width: 90%; max-width: 800px; border-radius: 24px; padding: 40px; max-height: 90vh; overflow-y: auto; }

        @media print { .sidebar, .no-print, .nav-link { display: none !important; } .modal { position: absolute; display: block; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1>Track<span>Envios</span></h1>
            <p style="color: var(--slate); margin-bottom: 20px;">Acceso al Sistema Log칤stico</p>
            <input type="text" id="user" class="login-input" placeholder="Usuario">
            <input type="password" id="pass" class="login-input" placeholder="Contrase침a">
            <button class="login-btn" onclick="handleLogin()">Ingresar</button>
        </div>
    </div>

    <aside class="sidebar">
        <div style="margin-bottom: 40px;"><h1 style="font-size: 22px; font-weight: 800;">Track<span style="color:var(--accent)">Envios</span></h1></div>
        
        <button class="nav-link active" onclick="nav('sec-pedidos', this)">游닍 Nuevo Pedido</button>
        <button class="nav-link" onclick="nav('sec-envios', this)">游뚴 Lista de Env칤os</button>

        <div id="admin-menu" class="admin-only">
            <p style="font-size: 10px; color: var(--warning); margin-bottom: 10px; font-weight: bold;">PANEL ADMINISTRADOR</p>
            <button class="nav-link" onclick="nav('sec-dash', this)">游늵 Dashboard</button>
            <button class="nav-link" onclick="nav('sec-stock', this)">游낈 Almac칠n</button>
            <button class="nav-link" onclick="nav('sec-clientes', this)">游논 Clientes</button>
            <button class="nav-link" onclick="nav('sec-users', this)">丘뙖잺 Gestionar Usuarios</button>
        </div>
        
        <button onclick="location.reload()" style="margin-top:auto; color:var(--danger)" class="nav-link">游뛁 Salir</button>
    </aside>

    <main class="main-content">
        <div id="sec-users" class="section">
            <h2>Gesti칩n de Personal</h2>
            <div class="card" style="max-width: 500px;">
                <label>Nombre del Usuario</label><input type="text" id="u-name" class="login-input">
                <label>Contrase침a</label><input type="password" id="u-pass" class="login-input">
                <label>Rango</label>
                <select id="u-role" class="login-input">
                    <option value="operador">Operador (Solo Pedidos y Remitos)</option>
                    <option value="admin">Administrador (Control Total)</option>
                </select>
                <button class="login-btn" onclick="createUser()">Crear Nuevo Usuario</button>
            </div>
            <div class="card">
                <table><thead><tr><th>Usuario</th><th>Rango</th><th>Acci칩n</th></tr></thead><tbody id="tbody-users"></tbody></table>
            </div>
        </div>

        <div id="sec-dash" class="section">
            <h2>Dashboard Administrativo</h2>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px">
                <div class="card"><h3>Total Pedidos</h3><p id="st-total" style="font-size:24px; font-weight:800">0</p></div>
                <div class="card"><h3>En Camino</h3><p id="st-pend" style="font-size:24px; font-weight:800">0</p></div>
                <div class="card"><h3>Alertas Stock</h3><p id="st-low" style="font-size:24px; font-weight:800; color:red">0</p></div>
            </div>
        </div>

        <div id="sec-pedidos" class="section active">
            <h2>Generar Env칤o</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="card">
                    <label>Cliente</label><select id="p-client" class="login-input"></select>
                    <label>Zona</label><input type="text" id="p-zona" class="login-input">
                    <label>Direcci칩n</label><input type="text" id="p-dir" class="login-input">
                    <button class="login-btn" onclick="finalizeOrder()">Finalizar Pedido</button>
                </div>
                <div class="card">
                    <label>Agregar Producto</label>
                    <div style="display:flex; gap:10px">
                        <select id="p-sku-select" style="flex:2" class="login-input"></select>
                        <input type="number" id="p-sku-qty" value="1" style="flex:1" class="login-input">
                    </div>
                    <button class="btn login-btn" style="background:#f1f5f9; color:black" onclick="addSkuToTemp()">+ A침adir a la lista</button>
                    <div id="temp-sku-list" style="margin-top:20px; border:1px dashed #ccc; padding:10px; border-radius:10px"></div>
                </div>
            </div>
        </div>

        <div id="sec-envios" class="section">
            <h2>Env칤os Registrados</h2>
            <div class="card">
                <table><thead><tr><th>ID</th><th>Cliente</th><th>Estado</th><th>Acci칩n</th></tr></thead><tbody id="tbody-orders"></tbody></table>
            </div>
        </div>

        <div id="sec-stock" class="section">
            <h2>Inventario</h2>
            <div class="card"><div style="display:flex; gap:10px"><input type="text" id="s-sku" placeholder="SKU"><input type="text" id="s-nom" placeholder="Nombre"><input type="number" id="s-cant" placeholder="Cantidad"><button class="login-btn" onclick="saveStock()">Cargar</button></div></div>
            <div class="card"><table><thead><tr><th>SKU</th><th>Producto</th><th>Stock</th></tr></thead><tbody id="tbody-stock"></tbody></table></div>
        </div>

        <div id="sec-clientes" class="section">
            <h2>Directorio Clientes</h2>
            <div class="card"><input type="text" id="c-name" placeholder="Nombre"><button class="login-btn" onclick="saveClient()">Guardar</button></div>
            <div class="card"><table><thead><tr><th>Nombre</th></tr></thead><tbody id="tbody-clients"></tbody></table></div>
        </div>
    </main>

    <div id="modal-remito" class="modal">
        <div class="modal-content">
            <div id="remito-body"></div>
            <div class="no-print" style="margin-top:20px; text-align:right">
                <button class="login-btn" style="width:auto; background:green" onclick="window.print()">IMPRIMIR REMITO</button>
                <button class="login-btn" style="width:auto; background:gray" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // BASE DE DATOS LOCAL
        let db = {
            users: JSON.parse(localStorage.getItem('sys_users')) || [{name: "BABY", pass: "06042006", role: "admin"}],
            stock: JSON.parse(localStorage.getItem('sys_stock')) || [],
            clients: JSON.parse(localStorage.getItem('sys_clients')) || [],
            orders: JSON.parse(localStorage.getItem('sys_orders')) || []
        };
        let currentUser = null;
        let tempOrderSkus = [];

        function handleLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            const found = db.users.find(x => x.name === u && x.pass === p);
            
            if(found) {
                currentUser = found;
                document.getElementById('login-screen').style.display = 'none';
                if(found.role === "admin") {
                    document.getElementById('admin-menu').style.display = 'block';
                }
                sync();
            } else { alert("Usuario o clave incorrecta"); }
        }

        function nav(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function sync() {
            localStorage.setItem('sys_users', JSON.stringify(db.users));
            localStorage.setItem('sys_stock', JSON.stringify(db.stock));
            localStorage.setItem('sys_clients', JSON.stringify(db.clients));
            localStorage.setItem('sys_orders', JSON.stringify(db.orders));
            render();
        }

        // GESTION USUARIOS
        function createUser() {
            db.users.push({
                name: document.getElementById('u-name').value,
                pass: document.getElementById('u-pass').value,
                role: document.getElementById('u-role').value
            });
            sync();
        }

        function deleteUser(i) {
            if(db.users[i].name === "BABY") return;
            db.users.splice(i, 1);
            sync();
        }

        // LOGICA DE PEDIDOS
        function addSkuToTemp() {
            const sku = document.getElementById('p-sku-select').value;
            const qty = parseInt(document.getElementById('p-sku-qty').value);
            const item = db.stock.find(x => x.sku === sku);
            if(!item || item.cant < qty) return alert("Sin stock");
            tempOrderSkus.push({sku, nom: item.nom, qty});
            renderTemp();
        }

        function renderTemp() {
            document.getElementById('temp-sku-list').innerHTML = tempOrderSkus.map(x => `<div>${x.sku} - ${x.qty} unidades</div>`).join('');
        }

        function finalizeOrder() {
            if(tempOrderSkus.length === 0) return;
            const order = {
                id: "TK-"+Math.floor(Math.random()*99999),
                client: document.getElementById('p-client').value,
                items: [...tempOrderSkus],
                zona: document.getElementById('p-zona').value,
                dir: document.getElementById('p-dir').value,
                status: "Pendiente",
                fecha: new Date().toLocaleString()
            };
            tempOrderSkus.forEach(t => { db.stock.find(s => s.sku === t.sku).cant -= t.qty; });
            db.orders.unshift(order);
            tempOrderSkus = [];
            sync();
            alert("Pedido Creado");
        }

        // REMITOS
        function openRemito(i) {
            const o = db.orders[i];
            document.getElementById('remito-body').innerHTML = `
                <div style="border:2px solid black; padding:20px; font-family: sans-serif;">
                    <h1>REMITO OFICIAL - TrackEnvios</h1>
                    <p><strong>Tracking:</strong> ${o.id}</p>
                    <p><strong>Cliente:</strong> ${o.client}</p>
                    <p><strong>Direcci칩n:</strong> ${o.dir} (${o.zona})</p><hr>
                    <h3>PRODUCTOS:</h3>
                    ${o.items.map(x => `<p>${x.sku} - ${x.nom} (Cant: ${x.qty})</p>`).join('')}
                    <br><br><br>
                    <p>Firma Receptor: ________________________</p>
                </div>`;
            document.getElementById('modal-remito').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modal-remito').style.display = 'none'; }

        // CARGAS ADMIN
        function saveStock() {
            db.stock.push({sku: document.getElementById('s-sku').value, nom: document.getElementById('s-nom').value, cant: parseInt(document.getElementById('s-cant').value)});
            sync();
        }
        function saveClient() {
            db.clients.push({name: document.getElementById('c-name').value});
            sync();
        }

        // RENDERS
        function render() {
            document.getElementById('tbody-users').innerHTML = db.users.map((u, i) => `<tr><td>${u.name}</td><td>${u.role}</td><td><button onclick="deleteUser(${i})">Eliminar</button></td></tr>`).join('');
            document.getElementById('tbody-stock').innerHTML = db.stock.map(s => `<tr><td>${s.sku}</td><td>${s.nom}</td><td>${s.cant}</td></tr>`).join('');
            document.getElementById('tbody-clients').innerHTML = db.clients.map(c => `<tr><td>${c.name}</td></tr>`).join('');
            document.getElementById('p-client').innerHTML = db.clients.map(c => `<option>${c.name}</option>`).join('');
            document.getElementById('p-sku-select').innerHTML = db.stock.map(s => `<option value="${s.sku}">${s.nom}</option>`).join('');
            document.getElementById('tbody-orders').innerHTML = db.orders.map((o, i) => `<tr><td>${o.id}</td><td>${o.client}</td><td>${o.status}</td><td><button onclick="openRemito(${i})">Ver Remito</button></td></tr>`).join('');
            
            document.getElementById('st-total').innerText = db.orders.length;
            document.getElementById('st-pend').innerText = db.orders.filter(x => x.status === "Pendiente").length;
            document.getElementById('st-low').innerText = db.stock.filter(x => x.cant < 5).length;
        }

        render();
    </script>
</body>
</html>
